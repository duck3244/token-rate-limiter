flowchart TD
    Start([ğŸš€ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì‹œì‘]) --> ValidateRequest{ğŸ“‹ ìš”ì²­ ìœ íš¨ì„± ê²€ì‚¬}
    
    ValidateRequest -->|ìœ íš¨í•˜ì§€ ì•ŠìŒ| InvalidRequest[âŒ 400 Bad Request ë°˜í™˜]
    InvalidRequest --> End([ğŸ ì¢…ë£Œ])
    
    ValidateRequest -->|ìœ íš¨í•¨| ExtractInfo[ğŸ“ ìš”ì²­ ì •ë³´ ì¶”ì¶œ<br/>â€¢ ModelId<br/>â€¢ UserId<br/>â€¢ Estimated Tokens]
    
    ExtractInfo --> CheckConcurrent{ğŸ”„ ë™ì‹œ ìš”ì²­ ìˆ˜<br/>í™•ì¸}
    
    CheckConcurrent -->|ì´ˆê³¼| ConcurrentLimitExceeded[ğŸš« ë™ì‹œ ìš”ì²­ ì œí•œ ì´ˆê³¼<br/>429 ì‘ë‹µ]
    ConcurrentLimitExceeded --> LogRateLimit[ğŸ“Š Rate Limit ë©”íŠ¸ë¦­ ê¸°ë¡]
    LogRateLimit --> End
    
    CheckConcurrent -->|í†µê³¼| IncrementConcurrent[â¬†ï¸ ë™ì‹œ ìš”ì²­ ì¹´ìš´íŠ¸ ì¦ê°€]
    
    IncrementConcurrent --> CheckMinuteLimit{â±ï¸ ë¶„ë‹¹ í† í°<br/>ì œí•œ í™•ì¸}
    
    CheckMinuteLimit -->|ì´ˆê³¼| MinuteLimitExceeded[ğŸš« ë¶„ë‹¹ ì œí•œ ì´ˆê³¼<br/>429 ì‘ë‹µ]
    MinuteLimitExceeded --> DecrementConcurrent[â¬‡ï¸ ë™ì‹œ ìš”ì²­ ì¹´ìš´íŠ¸ ê°ì†Œ]
    DecrementConcurrent --> LogRateLimit
    
    CheckMinuteLimit -->|í†µê³¼| CheckHourLimit{â° ì‹œê°„ë‹¹ í† í°<br/>ì œí•œ í™•ì¸}
    
    CheckHourLimit -->|ì´ˆê³¼| HourLimitExceeded[ğŸš« ì‹œê°„ë‹¹ ì œí•œ ì´ˆê³¼<br/>429 ì‘ë‹µ]
    HourLimitExceeded --> DecrementConcurrent
    
    CheckHourLimit -->|í†µê³¼| CheckDayLimit{ğŸ“… ì¼ë‹¹ í† í°<br/>ì œí•œ í™•ì¸}
    
    CheckDayLimit -->|ì´ˆê³¼| DayLimitExceeded[ğŸš« ì¼ë‹¹ ì œí•œ ì´ˆê³¼<br/>429 ì‘ë‹µ]
    DayLimitExceeded --> DecrementConcurrent
    
    CheckDayLimit -->|í†µê³¼| GetModelEndpoint[ğŸ” ëª¨ë¸ ì—”ë“œí¬ì¸íŠ¸ ì¡°íšŒ]
    
    GetModelEndpoint --> ModelFound{ğŸ¤– ëª¨ë¸ ì„œë²„<br/>ì¡´ì¬ í™•ì¸}
    
    ModelFound -->|ì—†ìŒ| ModelNotFound[âŒ 404 Model Not Found]
    ModelNotFound --> DecrementConcurrent
    
    ModelFound -->|ì¡´ì¬| CheckModelHealth{ğŸ’š ëª¨ë¸ ì„œë²„<br/>ìƒíƒœ í™•ì¸}
    
    CheckModelHealth -->|ë¶ˆëŸ‰| ModelUnavailable[ğŸ”´ 503 Service Unavailable]
    ModelUnavailable --> DecrementConcurrent
    
    CheckModelHealth -->|ì •ìƒ| ForwardRequest[ğŸ“¤ vLLM ì„œë²„ë¡œ<br/>ìš”ì²­ ì „ë‹¬]
    
    ForwardRequest --> ProcessingByModel[ğŸ¤– vLLMì—ì„œ<br/>ìš”ì²­ ì²˜ë¦¬]
    
    ProcessingByModel --> ModelResponse{ğŸ“¥ ëª¨ë¸ ì‘ë‹µ<br/>ìˆ˜ì‹ }
    
    ModelResponse -->|ì˜¤ë¥˜| ModelError[âŒ ëª¨ë¸ ì²˜ë¦¬ ì˜¤ë¥˜<br/>5xx ì‘ë‹µ]
    ModelError --> DecrementConcurrent
    
    ModelResponse -->|ì„±ê³µ| ExtractActualTokens[ğŸ“Š ì‹¤ì œ í† í° ì‚¬ìš©ëŸ‰<br/>ì¶”ì¶œ]
    
    ExtractActualTokens --> UpdateTokenUsage[ğŸ’¾ í† í° ì‚¬ìš©ëŸ‰ ì—…ë°ì´íŠ¸<br/>â€¢ ë¶„ë‹¹ ì‚¬ìš©ëŸ‰<br/>â€¢ ì‹œê°„ë‹¹ ì‚¬ìš©ëŸ‰<br/>â€¢ ì¼ë‹¹ ì‚¬ìš©ëŸ‰]
    
    UpdateTokenUsage --> RecordMetrics[ğŸ“ˆ ë©”íŠ¸ë¦­ ê¸°ë¡<br/>â€¢ Prometheus ë©”íŠ¸ë¦­<br/>â€¢ ì‚¬ìš©ëŸ‰ í†µê³„]
    
    RecordMetrics --> DecrementConcurrentSuccess[â¬‡ï¸ ë™ì‹œ ìš”ì²­ ì¹´ìš´íŠ¸ ê°ì†Œ]
    
    DecrementConcurrentSuccess --> LogSuccessfulRequest[ğŸ“ ì„±ê³µ ìš”ì²­ ë¡œê·¸ ê¸°ë¡]
    
    LogSuccessfulRequest --> ReturnResponse[âœ… 200 OK<br/>ëª¨ë¸ ì‘ë‹µ ë°˜í™˜]
    
    ReturnResponse --> End
    
    %% ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…ë“¤
    subgraph "Background Tasks"
        ScheduledCleanup[ğŸ§¹ ìŠ¤ì¼€ì¤„ëœ ì •ë¦¬ ì‘ì—…<br/>â€¢ ë§Œë£Œëœ í‚¤ ì‚­ì œ<br/>â€¢ í†µê³„ ìˆ˜ì§‘]
        HealthCheck[ğŸ’Š í—¬ìŠ¤ì²´í¬<br/>â€¢ Redis ì—°ê²° í™•ì¸<br/>â€¢ ëª¨ë¸ ì„œë²„ ìƒíƒœ]
        MetricCollection[ğŸ“Š ë©”íŠ¸ë¦­ ìˆ˜ì§‘<br/>â€¢ ì‹œê°„ë‹¹ í†µê³„<br/>â€¢ ì¼ì¼ í†µê³„]
    end
    
    %% ì˜¤ë¥˜ ì²˜ë¦¬ ì„œë¸Œí”Œë¡œìš°
    subgraph "Error Handling"
        RedisError{ğŸ’¥ Redis ì—°ê²°<br/>ì˜¤ë¥˜ ë°œìƒ?}
        FallbackMode[ğŸ”„ Fallback ëª¨ë“œ<br/>â€¢ ì„ì‹œ ë©”ëª¨ë¦¬ ìºì‹œ<br/>â€¢ ê¸°ë³¸ ì œí•œê°’ ì ìš©]
        CircuitBreaker[âš¡ Circuit Breaker<br/>â€¢ ëª¨ë¸ ì„œë²„ ì°¨ë‹¨<br/>â€¢ ëŒ€ì²´ ëª¨ë¸ ì‚¬ìš©]
    end
    
    %% ëª¨ë‹ˆí„°ë§ í”Œë¡œìš°
    subgraph "Monitoring Flow"
        PrometheusScrape[ğŸ“Š Prometheus ìŠ¤í¬ë˜í•‘]
        AlertEvaluation[ğŸš¨ ì•ŒëŒ í‰ê°€<br/>â€¢ Rate Limit ì„ê³„ê°’<br/>â€¢ ì˜¤ë¥˜ìœ¨ í™•ì¸]
        NotificationSend[ğŸ“§ ì•Œë¦¼ ë°œì†¡<br/>â€¢ Slack/Email<br/>â€¢ PagerDuty]
    end
    
    %% ì—°ê²° ê´€ê³„ (ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…)
    ScheduledCleanup -.-> UpdateTokenUsage
    HealthCheck -.-> CheckModelHealth
    MetricCollection -.-> RecordMetrics
    
    %% ì—°ê²° ê´€ê³„ (ì˜¤ë¥˜ ì²˜ë¦¬)
    UpdateTokenUsage --> RedisError
    RedisError -->|ì˜ˆ| FallbackMode
    FallbackMode --> RecordMetrics
    RedisError -->|ì•„ë‹ˆì˜¤| RecordMetrics
    
    CheckModelHealth --> CircuitBreaker
    CircuitBreaker -.-> ModelUnavailable
    
    %% ì—°ê²° ê´€ê³„ (ëª¨ë‹ˆí„°ë§)
    RecordMetrics -.-> PrometheusScrape
    PrometheusScrape -.-> AlertEvaluation
    AlertEvaluation -.-> NotificationSend
    
    %% ìŠ¤íƒ€ì¼ë§
    classDef startEnd fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px
    classDef process fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef success fill:#f1f8e9,stroke:#558b2f,stroke-width:2px
    classDef background fill:#f3e5f5,stroke:#7b1fa2,stroke-width:1px,stroke-dasharray: 5 5
    classDef monitoring fill:#fce4ec,stroke:#ad1457,stroke-width:1px,stroke-dasharray: 5 5
    
    class Start,End startEnd
    class ExtractInfo,IncrementConcurrent,GetModelEndpoint,ForwardRequest,ProcessingByModel,ExtractActualTokens,UpdateTokenUsage,RecordMetrics,DecrementConcurrentSuccess,LogSuccessfulRequest process
    class ValidateRequest,CheckConcurrent,CheckMinuteLimit,CheckHourLimit,CheckDayLimit,ModelFound,CheckModelHealth,ModelResponse,RedisError decision
    class InvalidRequest,ConcurrentLimitExceeded,MinuteLimitExceeded,HourLimitExceeded,DayLimitExceeded,ModelNotFound,ModelUnavailable,ModelError,DecrementConcurrent,LogRateLimit error
    class ReturnResponse success
    class ScheduledCleanup,HealthCheck,MetricCollection,FallbackMode,CircuitBreaker background
    class PrometheusScrape,AlertEvaluation,NotificationSend monitoring