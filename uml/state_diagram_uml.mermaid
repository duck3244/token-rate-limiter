stateDiagram-v2
    [*] --> Initial : 시스템 시작
    
    Initial --> Normal : 첫 번째 요청
    
    state Normal {
        [*] --> Checking
        Checking --> WithinLimits : 제한 내 사용량
        Checking --> ApproachingLimit : 80% 임계값 근접
        WithinLimits --> Checking : 새 요청
        ApproachingLimit --> Checking : 새 요청
        ApproachingLimit --> Warning : 90% 임계값 초과
        Warning --> Checking : 사용량 감소
        Warning --> RateLimited : 100% 제한 도달
    }
    
    state RateLimited {
        [*] --> MinuteLimit : 분당 제한 초과
        [*] --> HourLimit : 시간당 제한 초과
        [*] --> DayLimit : 일당 제한 초과
        [*] --> ConcurrentLimit : 동시 요청 제한 초과
        
        MinuteLimit --> Waiting : 대기 상태
        HourLimit --> Waiting : 대기 상태
        DayLimit --> Waiting : 대기 상태
        ConcurrentLimit --> Waiting : 대기 상태
        
        Waiting --> Recovering : 시간 경과
        Recovering --> [*] : 제한 해제
    }
    
    state ErrorStates {
        [*] --> RedisError : Redis 연결 오류
        [*] --> ModelError : 모델 서버 오류
        [*] --> SystemError : 시스템 오류
        
        RedisError --> FallbackMode : Fallback 활성화
        ModelError --> CircuitBreaker : Circuit Breaker 활성화
        SystemError --> Emergency : 긴급 모드
        
        FallbackMode --> Recovering : Redis 복구
        CircuitBreaker --> Recovering : 모델 서버 복구
        Emergency --> Recovering : 시스템 복구
        
        Recovering --> [*] : 정상 상태 복귀
    }
    
    state MaintenanceMode {
        [*] --> Scheduled : 예정된 유지보수
        [*] --> Emergency : 긴급 유지보수
        
        Scheduled --> ConfigUpdate : 설정 업데이트
        Scheduled --> DataCleanup : 데이터 정리
        Scheduled --> SystemUpgrade : 시스템 업그레이드
        
        Emergency --> QuickFix : 긴급 수정
        Emergency --> Rollback : 롤백
        
        ConfigUpdate --> [*] : 업데이트 완료
        DataCleanup --> [*] : 정리 완료
        SystemUpgrade --> [*] : 업그레이드 완료
        QuickFix --> [*] : 수정 완료
        Rollback --> [*] : 롤백 완료
    }
    
    state MonitoringStates {
        [*] --> Collecting : 메트릭 수집
        Collecting --> Analyzing : 데이터 분석
        Analyzing --> Alerting : 알람 발생
        Analyzing --> Reporting : 리포트 생성
        Alerting --> Notifying : 알림 발송
        Reporting --> Archiving : 데이터 보관
        Notifying --> [*] : 알림 완료
        Archiving --> [*] : 보관 완료
    }
    
    %% 상태 전환
    Normal --> RateLimited : 제한 초과
    RateLimited --> Normal : 제한 해제
    
    Normal --> ErrorStates : 오류 발생
    RateLimited --> ErrorStates : 오류 발생
    ErrorStates --> Normal : 복구 완료
    
    Normal --> MaintenanceMode : 유지보수 시작
    RateLimited --> MaintenanceMode : 유지보수 시작
    MaintenanceMode --> Normal : 유지보수 완료
    
    Normal --> MonitoringStates : 모니터링 트리거
    RateLimited --> MonitoringStates : 모니터링 트리거
    ErrorStates --> MonitoringStates : 모니터링 트리거
    MonitoringStates --> Normal : 모니터링 완료
    
    %% 종료 조건
    Normal --> [*] : 시스템 종료
    RateLimited --> [*] : 시스템 종료
    ErrorStates --> [*] : 시스템 종료
    MaintenanceMode --> [*] : 시스템 종료
    MonitoringStates --> [*] : 시스템 종료
    
    %% 노트 추가
    note right of Normal
        정상 운영 상태
        - 토큰 사용량 모니터링
        - 요청 처리
        - 성능 메트릭 수집
    end note
    
    note right of RateLimited
        사용량 제한 상태
        - 429 응답 반환
        - 재시도 헤더 포함
        - 제한 해제 대기
    end note
    
    note right of ErrorStates
        오류 처리 상태
        - Fallback 메커니즘
        - Circuit Breaker 패턴
        - 자동 복구 시도
    end note
    
    note right of MaintenanceMode
        유지보수 상태
        - 설정 변경
        - 시스템 업그레이드
        - 데이터 정리
    end note